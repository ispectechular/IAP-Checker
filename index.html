<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>IAP Watchlist</title>
<style>
  :root{
    --brand:#4A7A92; --muted:#D3DDD7; --ink:#1f2937; --ok:#2e7d32;
    --pillOkBg:#e8f5e9; --pillMutedBg:#eceff1; --shadow:0 10px 30px rgba(0,0,0,.06);
  }
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:24px; color:var(--ink); background:#f7fafc;}
  .wrap{max-width:900px; margin:auto;}
  h1{font-size:1.35rem; margin:0 0 8px; letter-spacing:.2px}
  .note{color:#6b7280; font-size:.9rem; margin:0 0 16px}
  .form{display:grid; grid-template-columns: 1fr 2fr auto; gap:10px; background:#fff; padding:14px; border-radius:14px; border:1px solid #eef2f7}
  input{border:1px solid #d7e3ea; border-radius:10px; padding:10px 12px; font-size:.95rem}
  button{appearance:none; border:none; background:var(--brand); color:#fff; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; box-shadow:0 6px 20px rgba(74,122,146,.3)}
  button.secondary{background:#fff; color:var(--brand); border:1px solid #d7e3ea}
  button.small{padding:6px 10px; border-radius:10px; font-weight:600}
  .header{display:flex; justify-content:space-between; align-items:center; margin:14px 0}
  .list .card{background:#fff; border-radius:14px; box-shadow:var(--shadow); padding:18px; margin:14px 0; display:flex; justify-content:space-between; gap:12px; border:1px solid #eef2f7; cursor:pointer}
  .name{font-weight:800}
  .url{font-size:.85rem; color:#6b7280; max-width:60ch; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .pill{padding:6px 12px; border-radius:999px; font-size:.84rem; font-weight:800; border:1px solid transparent}
  .pill.ok{background:var(--pillOkBg); color:var(--ok); border-color:#c8e6c9}
  .pill.muted{background:var(--pillMutedBg); color:#455a64; border-color:#e0e3e7}
  .actions{display:flex; gap:8px; align-items:center}
  .empty{color:#6b7280; text-align:center; padding:16px 8px}
  @media (max-width:720px){ .form{grid-template-columns:1fr} .url{max-width:100%} }
</style>
<div class="wrap">
  <h1>Indiana Waiting Children – Watchlist</h1>
  <p class="note">Tracks availability by detecting redirects to “Matched with Families”. Click a card to open the profile.</p>

  <div class="header">
    <div></div>
    <div class="actions">
      <button class="small" id="refresh">Refresh</button>
    </div>
  </div>

  <div class="form">
    <input id="name" placeholder="Child name (e.g., Jacob R.)">
    <input id="url" placeholder="Profile URL (indianaadoptionprogram.org)">
    <button id="add">Add</button>
  </div>

  <div id="list" class="list"></div>
  <p class="note" id="foot"></p>
</div>

<script>
const CHECKER_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyO9OcE0AoR_3ETam_NhB65-m0AFmpJ025QhiN5XEAwFTX4lzNjE9L33K0VeeP0clUN/exec';
const AUTO_REFRESH_MIN = 15;
const STORAGE_KEY = 'iap_watchlist_v1';

const nameEl = document.getElementById('name');
const urlEl  = document.getElementById('url');
const addBtn = document.getElementById('add');
const listEl = document.getElementById('list');
const refreshBtn = document.getElementById('refresh');
const foot = document.getElementById('foot');

let items = load();

function load(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY))||[] } catch{ return [] } }
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(items)) }
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) ) }

function render(){
  listEl.innerHTML = '';
  if (!items.length){ listEl.innerHTML = `<div class="empty">No children yet. Add above.</div>`; return }
  items.forEach((c, i) => {
    const pill = c.status==='available' ? `<span class="pill ok" title="Last checked: ${c.lastChecked||'—'}">Available</span>`
      : c.status==='matched' ? `<span class="pill muted" title="Last checked: ${c.lastChecked||'—'}">Matched</span>`
      : `<span class="pill muted" title="Last checked: ${c.lastChecked||'—'}">Unknown</span>`;
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `
      <div>
        <div class="name">${escapeHTML(c.name||'(Unnamed)')}</div>
        <div class="url">${escapeHTML(c.url)}</div>
      </div>
      <div class="actions">
        ${pill}
        <button class="secondary small" data-act="open" data-i="${i}">Open</button>
        <button class="secondary small" data-act="check" data-i="${i}">Check</button>
        <button class="secondary small" data-act="del" data-i="${i}">Delete</button>
      </div>`;
    card.addEventListener('click', e => {
      if (e.target.closest('button')) return;
      window.open(c.url, '_blank');
    });
    card.querySelector('[data-act="open"]').onclick  = e => { e.stopPropagation(); window.open(c.url, '_blank'); }
    card.querySelector('[data-act="check"]').onclick = e => { e.stopPropagation(); checkOne(i) }
    card.querySelector('[data-act="del"]').onclick   = async e => {
      e.stopPropagation();
      if (!confirm(`Remove ${c.name||'this entry'}?`)) return;
      await serverDelete(c.url);
      items.splice(i,1); save(); render();
    }
    listEl.appendChild(card);
  });
}

addBtn.onclick = async () => {
  const name = nameEl.value.trim();
  const url  = urlEl.value.trim();
  if (!/^https?:\/\//i.test(url) || !/indianaadoptionprogram\.org/i.test(url)) {
    alert('Paste a valid indianaadoptionprogram.org profile URL.'); return;
  }
  items.push({ name: name||'(Unnamed)', url, status:'unknown', lastChecked:null });
  save(); render();
  nameEl.value=''; urlEl.value='';
  await serverUpsert(name||'', url); // register in server
};

refreshBtn.onclick = () => checkAll();

async function serverUpsert(name, url){
  try {
    const u = new URL(CHECKER_ENDPOINT);
    u.searchParams.set('mode','upsert');
    u.searchParams.set('name', name);
    u.searchParams.set('url', url);
    // GET to avoid CORS preflight
    await fetch(u.toString(), { method:'GET' });
  } catch {}
}
async function serverDelete(url){
  try {
    const u = new URL(CHECKER_ENDPOINT);
    u.searchParams.set('mode','delete');
    u.searchParams.set('url', url);
    await fetch(u.toString(), { method:'GET' });
  } catch {}
}

async function checkOne(i){
  const c = items[i]; if (!c) return;
  try{
    const u = new URL(CHECKER_ENDPOINT);
    u.searchParams.set('mode','check');
    u.searchParams.set('url', c.url);
    if (c.name) u.searchParams.set('name', c.name);
    const r = await fetch(u.toString(), { method:'GET' });
    const j = await r.json();
    const now = new Date().toLocaleString();
    if (j && j.ok) { c.status = j.status || (j.matched?'matched': j.available?'available':'unknown'); c.lastChecked = now; }
    else { c.status='unknown'; c.lastChecked = now; }
  } catch {
    c.status='unknown'; c.lastChecked = new Date().toLocaleString();
  } finally { save(); render(); }
}

function checkAll(){
  if (!items.length) return;
  items.forEach((_, i) => setTimeout(()=>checkOne(i), i*500));
}

render();
foot.textContent = `Auto-refreshes every ${AUTO_REFRESH_MIN} minutes.`;
setInterval(checkAll, AUTO_REFRESH_MIN*60*1000);
if (items.length) checkAll();
</script>
</html>
