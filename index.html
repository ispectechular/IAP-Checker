<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>IAP Watchlist</title>
<style>
  :root{
    --bg: #0b0f14;          /* canvas background */
    --card: #0f1520;        /* card */
    --ink: #e6edf3;         /* text */
    --muted: #9fb0c0;       /* secondary text */
    --ring: rgba(56,189,248,.25);
    --brand: #5db0ff;       /* accent */
    --ok: #30d158;          /* available */
    --pill-ok-bg: rgba(48,209,88,.12);
    --pill-ok-br: rgba(48,209,88,.35);
    --pill-mu-bg: rgba(159,176,192,.12);
    --pill-mu-br: rgba(159,176,192,.35);
    --br: 14px;
    --shadow: 0 12px 40px rgba(0,0,0,.35);
  }

  @media (prefers-color-scheme: light){
    :root{
      --bg:#f7f9fc; --card:#ffffff; --ink:#111827; --muted:#6b7280; --ring:rgba(93,176,255,.25);
      --shadow: 0 10px 30px rgba(16,24,40,.08);
    }
  }

  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;}

  .wrap{max-width:820px;margin:0 auto;padding:20px;}

  /* Header */
  .header{display:flex;align-items:center;justify-content:space-between;margin:10px 0 16px;}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,#1b2a3a,#213247 55%,#2e4561);
        display:grid;place-items:center;box-shadow:var(--shadow);}
  .logo:before{content:"";width:16px;height:16px;border-radius:5px; background:radial-gradient(circle at 30% 30%, #5db0ff, #7cd2ff 60%, #bfe6ff 100%);
               filter:drop-shadow(0 2px 6px rgba(93,176,255,.6));}
  .title{font-size:1.25rem;font-weight:800;letter-spacing:.2px}
  .subtitle{font-size:.9rem;color:var(--muted);display:none}

  /* Card + list */
  .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:18px;box-shadow:var(--shadow);padding:14px;}

  .form{display:grid;grid-template-columns:1fr 2fr;gap:10px;margin-bottom:10px}
  .input{background:transparent;border:1px solid rgba(145,158,171,.35);border-radius:12px;padding:10px 12px;color:var(--ink);
         font-size:.95rem;outline:none}
  .input:focus{border-color:var(--brand);box-shadow:0 0 0 6px var(--ring)}

  .list{display:flex;flex-direction:column;gap:8px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border:1px solid rgba(145,158,171,.25);
       background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
       border-radius:14px}
  .name a{color:var(--ink);text-decoration:none;font-weight:800}
  .name a:hover{text-decoration:underline;color:var(--brand)}

  .pill{padding:6px 12px;border-radius:999px;font-size:.82rem;font-weight:800;border:1px solid transparent;white-space:nowrap;}
  .ok{background:var(--pill-ok-bg);color:var(--ok);border-color:var(--pill-ok-br)}
  .muted{background:var(--pill-mu-bg);color:var(--muted);border-color:var(--pill-mu-br)}

  @media (max-width:720px){
    .form{grid-template-columns:1fr}
    .title{font-size:1.1rem}
  }
</style>
<div class="wrap">
  <header class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">IAP Watchlist</div>
      </div>
    </div>
  </header>

  <section class="card">
    <form class="form" id="f" autocomplete="off">
      <input class="input" id="n" placeholder="Name" aria-label="Name">
      <input class="input" id="u" placeholder="Profile URL (indianaadoptionprogram.org)" aria-label="Profile URL">
    </form>
    <div id="list" class="list"></div>
  </section>
</div>

<script>
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbyO9OcE0AoR_3ETam_NhB65-m0AFmpJ025QhiN5XEAwFTX4lzNjE9L33K0VeeP0clUN/exec';
const KEY = 'iap_watch_min_v2';
const AUTO_MIN = 15;

const f = document.getElementById('f');
const n = document.getElementById('n');
const u = document.getElementById('u');
const listEl = document.getElementById('list');

let items = load();

f.addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = n.value.trim();
  const url  = u.value.trim();
  if (!/^https?:\/\//i.test(url) || !/indianaadoptionprogram\.org/i.test(url)) return;
  items.push({name, url, status:'unknown', lastChecked:null});
  save(); render();
  n.value=''; u.value='';
  await upsert(name,url);
  checkAll();
});

n.addEventListener('keydown', e => { if (e.key === 'Enter') f.requestSubmit(); });
u.addEventListener('keydown', e => { if (e.key === 'Enter') f.requestSubmit(); });

function load(){ try { return JSON.parse(localStorage.getItem(KEY))||[] } catch{ return [] } }
function save(){ localStorage.setItem(KEY, JSON.stringify(items)) }
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) ) }

function pill(status){
  const cls = status==='available' ? 'pill ok' : 'pill muted';
  const txt = status==='available' ? 'Available' : status==='matched' ? 'Matched' : 'Unknown';
  return `<span class="${cls}">${txt}</span>`;
}

function render(){
  listEl.innerHTML = '';
  items.forEach((c,i) => {
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <div class="name"><a href="${c.url}" target="_blank" rel="noopener">${escapeHTML(c.name||'(Unnamed)')}</a></div>
      ${pill(c.status)}
    `;
    listEl.appendChild(row);
  });
}

async function upsert(name,url){
  try{
    const q = new URL(ENDPOINT);
    q.searchParams.set('mode','upsert');
    q.searchParams.set('name', name);
    q.searchParams.set('url', url);
    await fetch(q.toString(), { method:'GET' });
  } catch {}
}

async function checkOne(i){
  const c = items[i]; if (!c) return;
  try{
    const q = new URL(ENDPOINT);
    q.searchParams.set('mode','check');
    q.searchParams.set('url', c.url);
    if (c.name) q.searchParams.set('name', c.name);
    const r = await fetch(q.toString(), { method:'GET' });
    const txt = await r.text();
    const j = JSON.parse(txt);
    c.status = j && j.ok ? (j.status || (j.matched?'matched': j.available?'available':'unknown')) : 'unknown';
    c.lastChecked = new Date().toLocaleString();
  } catch {
    c.status = 'unknown';
    c.lastChecked = new Date().toLocaleString();
  } finally {
    save(); render();
  }
}

function checkAll(){
  if (!items.length) return;
  items.forEach((_, i) => setTimeout(()=>checkOne(i), i*350));
}

render();
if (items.length) checkAll();
setInterval(checkAll, AUTO_MIN*60*1000);
</script>
</html>
